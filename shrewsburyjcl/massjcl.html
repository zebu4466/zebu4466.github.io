<!-- ✅ Responsive Image Map Container -->
<div style="max-width: 100%; position: relative;">
  <img 
    src="./massachusetts.png" 
    usemap="#image-map" 
    style="width: 100%; height: auto; display: block; overflow: hidden;"
    alt="Massachusetts Map">
<div id="rotateOverlay" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: white;
  color: black;
  display: none;
  justify-content: center;
  align-items: center;
  text-align: center;
  font-size: 1.5rem;
  font-family: system-ui, sans-serif;
  z-index: 9999;
  padding: 20px;
  box-sizing: border-box;
">
  Please rotate your device to <strong>landscape mode</strong>.
</div>
  <map name="image-map">
<area target="_blank" alt="Boston Latin Academy" title="Boston Latin Academy" href="https://blacc.majcl.org/" coords="2312,1546,NaN" shape="circle">
    <area target="_blank" alt="Boston Latin School" title="Boston Latin School" href="https://www.bls-jcl.org/" coords="2398,1425,NaN" shape="circle">
    <area target="_blank" alt="Weston High School" title="Weston High School" href="https://www.westonlatinclub.com/" coords="2035,1603,NaN" shape="circle">
    <area target="_blank" alt="Winchester High School" title="Winchester High School" href="https://sites.google.com/wpsstudent.com/whsjcl/home" coords="2194,1221,NaN" shape="circle">
    <area target="_blank" alt="Shrewsbury High School" title="Shrewsbury High School" href="https://sites.google.com/view/shrewsbury-jcl" coords="1638,1479,NaN" shape="circle">
  </map>
</div>

<script>
  const AREA_RADIUS = 15;
  const ICON_SCALE = 2.5;

  function resizeImageMap() {
    const images = document.querySelectorAll('img[usemap]');
    images.forEach(img => {
      if (!img.naturalWidth || !img.naturalHeight) return;

      const w = img.naturalWidth;
      const h = img.naturalHeight;
      const mapName = img.getAttribute('usemap').replace('#', '');
      const areas = document.querySelectorAll(`map[name="${mapName}"] area`);

      areas.forEach(area => {
        const original = area.dataset.coords;
        if (!original) return;

        const coordsArr = original.split(',').map(Number);
        if (coordsArr.length === 3) coordsArr[2] = AREA_RADIUS;

        const scaledCoords = [
          coordsArr[0] / w * img.width,
          coordsArr[1] / h * img.height,
          coordsArr[2] / w * img.width
        ];

        area.setAttribute('coords', scaledCoords.join(','));
      });

      repositionMarkers(img);
    });
  }

  function repositionMarkers(img) {
    const parent = img.parentElement;
    const areas = document.querySelectorAll(`map[name="${img.getAttribute('usemap').replace('#','')}"] area`);
    const markers = parent.querySelectorAll('.jcl-marker');

    markers.forEach(m => m.remove());

    areas.forEach(area => {
      const coords = area.dataset.coords;
      if (!coords) return;

      const [x, y] = coords.split(',').map(Number);
      if (Number.isNaN(x) || Number.isNaN(y)) return;

      const marker = document.createElement('a');
      marker.href = area.href;
      marker.target = area.target || '_blank';
      marker.className = 'jcl-marker';
      marker.style.position = 'absolute';
      marker.style.left = `${(x / img.naturalWidth) * 100}%`;
      marker.style.top = `${(y / img.naturalHeight) * 100}%`;
      marker.style.transform = 'translate(-50%, -50%)';
      marker.style.display = 'block';
      marker.style.zIndex = 10;

      const icon = document.createElement('img');
      icon.src = 'https://www.njcl.org/Portals/1/JCL_wreath.png';
      icon.style.width = `${AREA_RADIUS * ICON_SCALE}px`;
      icon.style.height = 'auto';
      icon.style.pointerEvents = 'none';

      // ✅ Make all valid links visible, including http:// and mailto:
      if (area.href.startsWith('http://') || area.href.startsWith('https://')) {
        icon.style.opacity = '1';
      } else if (area.href.startsWith('mailto:')) {
        icon.style.opacity = '0.5';
      } else {
        icon.style.opacity = '0';
        marker.style.pointerEvents = 'none';
      }

      marker.appendChild(icon);
      parent.appendChild(marker);
    });
  }

  function updateOverlay() {
    const overlay = document.getElementById('rotateOverlay');
    const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isPortrait = window.matchMedia('(orientation: portrait)').matches || window.innerHeight > window.innerWidth;
    overlay.style.display = (isMobile && isPortrait) ? 'flex' : 'none';
  }

  window.addEventListener('resize', () => {
    resizeImageMap();
    updateOverlay();
  });

  window.addEventListener('orientationchange', () => {
    setTimeout(updateOverlay, 200);
  });

  window.addEventListener('load', () => {
    const img = document.querySelector('img[usemap]');

    function initialize() {
      const areas = document.querySelectorAll('map[name="image-map"] area');

      // Store original coords exactly once
      areas.forEach(area => {
        if (!area.dataset.coords) {
          area.dataset.coords = area.getAttribute('coords');
        }
      });

      resizeImageMap();
      updateOverlay();
      setTimeout(updateOverlay, 400);
    }

    if (img.complete) {
      initialize();
    } else {
      img.addEventListener('load', initialize);
    }
  });
</script>
